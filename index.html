<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EduTrack - Pro Enhanced</title>
    <link rel="icon" type="image/png" href="https://edutrackeg.com/_next/image?url=%2Ffavicon.ico&w=1920&q=75">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            /* 1. THEME UPDATED TO BLUE */
            --primary: #3d5afe;          /* Royal Blue */
            --primary-dark: #304ffe;     /* Darker Blue */
            --secondary: #2F2E41;
            --accent: #00cec9;
            --danger: #ff7675;
            --success: #00b894;
            
            --bg-body: #f3f4f8;
            --glass: rgba(255, 255, 255, 0.95);
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.05);
            --radius: 16px;
            /* Blue Gradient for Sidebar */
            --sidebar-grad: linear-gradient(180deg, #3d5afe 0%, #304ffe 100%); 
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-body); color: var(--secondary); min-height: 100vh; display: flex; flex-direction: column; overflow-x: hidden; }

        /* --- ANIMATIONS --- */
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 260px; 
            background: var(--sidebar-grad);
            padding: 20px 15px; 
            height: 100vh; 
            position: fixed; 
            top: 0; left: 0; 
            color: white;
            display: flex; flex-direction: column; 
            z-index: 1100;
            /* Updated Shadow to Blue-ish */
            box-shadow: 5px 0 25px rgba(61, 90, 254, 0.25);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
        }

        .brand { 
            font-size: 1.4rem; font-weight: 800; margin-bottom: 25px; 
            display: flex; align-items: center; gap: 10px; letter-spacing: 0.5px;
            padding: 0 10px; flex-shrink: 0;
        }

        /* Profile Compact */
        .profile-card {
            background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(8px);
            padding: 15px; border-radius: 16px; text-align: center;
            margin-bottom: 25px; border: 1px solid rgba(255, 255, 255, 0.2);
            flex-shrink: 0;
        }
        
        .avatar {
            width: 55px; height: 55px; margin: 0 auto 8px;
            background: white; color: var(--primary); border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; font-weight: 700; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            position: relative;
        }
        .status-dot {
            position: absolute; bottom: 2px; right: 2px; width: 12px; height: 12px;
            background: var(--success); border: 2px solid white; border-radius: 50%;
        }
        
        .profile-name { font-size: 0.95rem; font-weight: 600; margin-bottom: 2px; text-transform: capitalize; }
        .profile-role { font-size: 0.75rem; opacity: 0.9; margin-bottom: 10px; font-weight: 300; }
        .profile-actions { display: flex; justify-content: center; gap: 8px; }
        .icon-btn {
            background: rgba(255,255,255,0.2); border: none; color: white;
            width: 32px; height: 32px; border-radius: 8px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: 0.2s;
        }
        .icon-btn:hover { background: white; color: var(--primary); transform: translateY(-2px); }

        /* Nav Buttons */
        .nav-section { flex-grow: 1; display: flex; flex-direction: column; gap: 6px; }
        .nav-btn {
            background: transparent; border: none; width: 100%; padding: 12px 15px;
            text-align: left; cursor: pointer; color: rgba(255,255,255,0.9); border-radius: 10px;
            display: flex; align-items: center; gap: 12px; 
            font-size: 0.9rem; font-weight: 500; transition: 0.2s ease;
        }
        .nav-btn:hover { background: rgba(255,255,255,0.15); color: white; padding-left: 20px; }
        .nav-btn.active { background: white; color: var(--primary); font-weight: 700; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .nav-btn i { width: 20px; text-align: center; }
        
        .sidebar-footer { margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2); flex-shrink: 0; }

        /* --- MAIN CONTENT --- */
        .main-content { margin-left: 260px; padding: 30px; width: calc(100% - 260px); transition: 0.3s; }

        .section-card { 
            display: none; animation: slideIn 0.3s ease-out; 
            background: var(--glass); backdrop-filter: blur(12px);
            padding: 25px; border-radius: var(--radius); 
            box-shadow: var(--shadow); border: 1px solid white; 
            margin-bottom: 25px; 
        }
        .section-card.active { display: block; }

        /* DASHBOARD GRID */
        .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card {
            background: white; padding: 20px; border-radius: var(--radius);
            box-shadow: var(--shadow); position: relative; overflow: hidden;
            display: flex; flex-direction: column; justify-content: center;
            border-left: 4px solid transparent; transition: transform 0.3s;
        }
        .stat-card:hover { transform: translateY(-3px); }
        .card-blue { border-color: #54a0ff; } .card-blue .val { color: #54a0ff; }
        .card-purple { border-color: #5f27cd; } .card-purple .val { color: #5f27cd; }
        .card-pink { border-color: #ff6b6b; } .card-pink .val { color: #ff6b6b; }
        .stat-card h3 { font-size: 0.75rem; color: #8395a7; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; }
        .stat-card .val { font-size: 1.8rem; font-weight: 700; margin-top: 5px; }
        .stat-card .sub { font-size: 0.75rem; color: #b2bec3; }
        .stat-card i { position: absolute; right: 15px; bottom: 15px; font-size: 3rem; opacity: 0.05; }

        .split-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .page-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 25px; align-items: start; }
        
        .chart-box { background: white; padding: 15px; border-radius: var(--radius); box-shadow: var(--shadow); height: 300px; position: relative; }
        .mini-charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 15px; margin-top: 20px; }
        .mini-chart-card { background: white; padding: 15px; border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid #f1f2f6; }

        /* Forms */
        label { display: block; margin-bottom: 5px; font-weight: 600; color: var(--secondary); font-size: 0.85rem; }
        .form-control { 
            width: 100%; height: 45px; padding: 0 15px; 
            border: 2px solid #e0e0e0; border-radius: 10px; 
            margin-bottom: 15px; outline: none; font-size: 0.9rem; 
            transition: 0.3s; background: #fafafa; appearance: none;
        }
        /* Updated Focus Shadow to Blue */
        .form-control:focus { border-color: var(--primary); background: white; box-shadow: 0 0 0 3px rgba(61, 90, 254, 0.1); }
        
        .btn { 
            height: 45px; padding: 0 25px; border: none; border-radius: 10px; 
            font-weight: 600; cursor: pointer; transition: 0.3s; font-size: 0.9rem;
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        }
        /* Updated Button Shadow to Blue */
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(61, 90, 254, 0.2); }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); }
        
        .tag-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 5px; }
        .item-tag { 
            padding: 6px 14px; border-radius: 50px; font-weight: 500; font-size: 0.85rem; 
            display: flex; align-items: center; gap: 8px; cursor: pointer; transition: 0.2s;
        }
        .item-tag:hover { transform: scale(1.05); }
        .tag-sub { background: #e0f7fa; color: #0097a7; border: 1px solid #b2ebf2; }
        .tag-exam { background: #f3e5f5; color: #9c27b0; border: 1px solid #e1bee7; }

        /* Tables */
        table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        th { text-align: left; padding: 12px; color: #8395a7; font-size: 0.8rem; text-transform: uppercase; font-weight: 700; }
        td { background: white; padding: 12px; border-top: 1px solid #f5f6fa; border-bottom: 1px solid #f5f6fa; vertical-align: middle; font-size: 0.9rem; }
        tr:hover td { background: #fcfcfc; }
        tr td:first-child { border-left: 1px solid #f5f6fa; border-radius: 10px 0 0 10px; font-weight: 600; color: var(--primary); }
        tr td:last-child { border-right: 1px solid #f5f6fa; border-radius: 0 10px 10px 0; text-align: right; }

        .action-btn { 
            background: #f1f2f6; border: none; width: 30px; height: 30px; 
            border-radius: 50%; cursor: pointer; color: var(--secondary); margin-left: 5px; transition: 0.2s;
            display: inline-flex; align-items: center; justify-content: center;
        }
        .action-btn:hover { background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); color: var(--primary); transform: scale(1.1); }
        .btn-del:hover { color: var(--danger); }

        /* TIMETABLE STYLES */
        .schedule-item {
            background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03); border-left: 4px solid var(--primary);
            display: flex; justify-content: space-between; align-items: center; page-break-inside: avoid;
        }
        .schedule-time { font-weight: 700; color: var(--primary); font-size: 0.9rem; display: block; }
        .schedule-title { font-weight: 500; font-size: 1rem; color: #333; }
        .weekend-item { border-left-color: var(--accent); }
        .weekend-item .schedule-time { color: var(--accent); }

        .time-inputs { display: flex; gap: 10px; }
        .time-inputs input { flex: 1; }

        /* --- REPORT TOOLBAR --- */
        .report-toolbar {
            background: white;
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            display: flex;
            flex-wrap: wrap; 
            gap: 20px;
            align-items: flex-end;
            border: 1px solid #eee;
        }
        
        .filter-group { flex: 1 1 200px; min-width: 200px; }
        #dynamicFilterContainer { flex: 1 1 200px; min-width: 200px; }
        .date-group { flex: 2 1 300px; display: flex; gap: 10px; min-width: 250px; }
        .date-group > div { flex: 1; }
        .btn-group-responsive { flex: 1 1 180px; display: flex; gap: 10px; min-width: 180px; }

        .report-toolbar select, .report-toolbar input, .report-toolbar button {
            margin-bottom: 0 !important;
            width: 100%;
        }

        /* The A4 Paper Effect */
        .report-paper {
            background: white;
            width: 100%;
            max-width: 210mm; /* A4 width */
            min-height: 297mm; /* A4 height */
            margin: 0 auto;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-radius: 2px;
            display: none; /* Hidden by default */
            position: relative;
        }

        /* --- CLEAN SCREEN VIEW LOGIC --- */
        .report-header {
            text-align: center;
            border-bottom: 3px solid #333;
            padding-bottom: 20px;
            margin-bottom: 30px;
            display: none; /* Hidden on Screen */
        }
        .student-details-grid {
            display: none; /* Hidden on Screen */
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            background: #f8f9fa;
            padding: 20px;
            border: 1px solid #ddd;
            margin-bottom: 30px;
        }
        
        .report-brand { font-size: 2rem; font-weight: 800; color: #333; letter-spacing: 1px; text-transform: uppercase; }
        .report-sub { font-size: 0.9rem; color: #666; margin-top: 5px; }
        .detail-item strong { display: block; font-size: 0.8rem; color: #666; text-transform: uppercase; }
        .detail-item span { font-size: 1.1rem; font-weight: 600; color: #333; }

        /* Report Table Base (Screen View) */
        .report-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .report-table th { background: #333; color: white; padding: 12px; border: 1px solid #333; text-align: center; }
        .report-table td { border: 1px solid #ddd; padding: 10px; text-align: center; color: #333; }
        .report-table tr:nth-child(even) { background: #f9f9f9; }

        .report-summary { margin-top: 30px; text-align: right; font-size: 1.2rem; font-weight: 700; color: #333; }
        .signature-section { display: none; margin-top: 80px; display: flex; justify-content: space-between; }
        
        /* --- MODALS --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px);
            z-index: 2000; display: none; align-items: center; justify-content: center;
        }
        .modal-overlay.open { display: flex; animation: fadeIn 0.2s; }
        .modal-box {
            background: white; width: 90%; max-width: 450px; padding: 25px;
            border-radius: 20px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .profile-form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: left; }
        .full-width { grid-column: span 2; }

        /* Mobile Nav */
        .mobile-header { display: none; padding: 15px 20px; background: var(--sidebar-grad); color: white; justify-content: space-between; align-items: center; position: fixed; top: 0; width: 100%; z-index: 1000; box-shadow: 0 2px 15px rgba(0,0,0,0.1); }
        .menu-toggle { font-size: 1.4rem; cursor: pointer; }
        .sidebar-backdrop { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1050; display:none; backdrop-filter:blur(3px); }
        .sidebar-backdrop.active { display: block; }
        .close-btn { display:none; position:absolute; top:20px; right:20px; font-size:1.5rem; cursor:pointer; }

        /* Responsive */
        @media (max-width: 992px) { 
            /* Tablet: Charts 2 column */
            .stats-row { grid-template-columns: 1fr 1fr; } 
        }

        /* --- MOBILE SPECIFIC OVERRIDES --- */
        @media (max-width: 768px) {
            .mobile-header { display: flex; }
            .sidebar { transform: translateX(-100%); width: 85%; }
            .sidebar.active { transform: translateX(0); }
            .close-btn { display: block; }
            .main-content { margin-left: 0; padding: 20px; padding-top: 80px; width: 100%; }
            
            /* --- DASHBOARD MOBILE DESIGN --- */
            
            /* 1. Overview: Grid Layout */
            .stats-row { 
                display: grid !important; 
                grid-template-columns: 1fr 1fr !important; /* 2 Columns */
                gap: 15px; 
                overflow: visible !important; 
                padding-bottom: 0;
                margin-right: 0;
                padding-right: 0;
            }
            
            /* Make the 3rd card span full width for nice alignment */
            .stat-card:nth-child(3) {
                grid-column: span 2; 
            }

            .stat-card { 
                width: 100% !important; 
                min-width: 0 !important;
                margin-bottom: 0 !important;
            }

            /* 2. Charts: 1 PER ROW on Mobile */
            .mini-charts-grid {
                display: grid !important;
                grid-template-columns: 1fr !important; /* Force Single Column */
                gap: 25px !important;
                width: 100% !important;
            }
            .mini-chart-card { 
                padding: 15px !important; 
                width: 100% !important;
            }
            .mini-chart-card h5 { 
                font-size: 0.9rem !important; 
                margin-bottom: 10px !important; 
            }
            .mini-chart-card canvas {
                max-width: 100% !important;
            }

            /* --- REPORT PAGE MOBILE --- */
            .report-toolbar { flex-direction: column !important; align-items: stretch !important; gap: 15px !important; }
            .filter-group, #dynamicFilterContainer, .btn-group-responsive { width: 100% !important; flex: none !important; min-width: 0 !important; }
            .date-group { width: 100% !important; flex: none !important; min-width: 0 !important; display: flex !important; flex-direction: row !important; gap: 10px !important; }
            .date-group > div { flex: 1 !important; width: 50% !important; }

            .page-grid, .split-grid { display: flex; flex-direction: column; gap: 20px; }
            .report-paper { padding: 20px; width: 100%; min-height: auto; }
            .btn-group-responsive { flex-direction: row; gap: 10px; }
            
            /* GLOBAL MOBILE TABLE (Card View) */
            .main-content table:not(.report-table), 
            .main-content table:not(.report-table) thead, 
            .main-content table:not(.report-table) tbody, 
            .main-content table:not(.report-table) tr, 
            .main-content table:not(.report-table) td { display: block; width: 100%; }
            .main-content table:not(.report-table) thead { display: none; }
            
            /* --- UPDATED: 2 CARDS PER ROW FOR TABLES --- */
            .main-content table:not(.report-table) tbody {
                display: grid !important;
                grid-template-columns: 1fr 1fr !important; /* Split into 2 columns */
                gap: 15px !important;
                width: 100% !important;
            }

            .main-content table:not(.report-table) tr { 
                margin-bottom: 0 !important; 
                background: white; 
                border-radius: 16px; 
                box-shadow: 0 4px 10px rgba(0,0,0,0.05); 
                border: 1px solid #eee; 
                overflow: hidden; 
                display: flex !important;
                flex-direction: column; /* Stack cell contents vertically inside the card */
                width: auto !important; /* Let grid handle width */
                height: 100%; /* Equal height cards */
            }

            .main-content table:not(.report-table) td { 
                display: flex; 
                justify-content: space-between; 
                align-items: center; 
                padding: 10px 12px; /* Tighter padding for small cards */
                border-bottom: 1px solid #f5f5f5; 
                text-align: right; 
                font-size: 0.85rem;
            }
            .main-content table:not(.report-table) td::before { 
                content: attr(data-label); 
                font-weight: 600; 
                color: #b2bec3; 
                font-size: 0.75rem; 
                text-transform: uppercase; 
                text-align: left; 
            }
            .main-content table:not(.report-table) td:last-child { 
                background: #fafafa; 
                border: none; 
                justify-content: space-between; /* Spread actions out */
                gap: 5px; 
                padding: 10px 12px;
                margin-top: auto; /* Push to bottom */
            }
            
            /* REPORT TABLE SPECIFIC - FORCE SINGLE LINE ON MOBILE SCREEN */
            .report-table, .report-table tbody, .report-table thead, .report-table tr, .report-table th, .report-table td { display: revert !important; }
            .report-table { display: table !important; width: 100% !important; table-layout: fixed; }
            .report-table tr { display: table-row !important; background: transparent !important; box-shadow: none !important; border: none !important; }
            .report-table td { 
                display: table-cell !important; 
                text-align: center !important; 
                border: 1px solid #ddd !important; 
                padding: 8px !important; 
                white-space: nowrap; 
                overflow: hidden; 
                text-overflow: ellipsis; 
            }
            .report-table th { display: table-cell !important; text-align: center; }
            .report-table td::before { content: none !important; }
            .report-table td:first-child, .report-table th:first-child { text-align: left !important; }
            
            .btn-text { display: inline-block; font-size: 0.8rem; margin-left: 5px; }
        }
        @media (min-width: 769px) { .btn-text { display: none; } }

        /* --- PRINT STYLES --- */
        @media print {
            .sidebar, .mobile-header, .btn, .no-print, .action-btn, .report-toolbar, .section-card:not(#reports) { display: none !important; }
            body { background: white; }
            .main-content { margin: 0; padding: 0; width: 100%; }
            #reports { display: block !important; border: none; box-shadow: none; padding: 0; }
            .report-paper { display: block !important; box-shadow: none; margin: 0; width: 100%; max-width: 100%; padding: 0; }
            .report-header, .student-details-grid, .signature-section { display: block !important; }
            .student-details-grid { display: grid !important; background: transparent !important; border: 1px solid black !important; }
            .signature-section { display: flex !important; }

            /* FORCE TABLE RESET */
            .report-table, .report-table tbody, .report-table thead, .report-table tr, .report-table th, .report-table td { display: revert !important; }
            .report-table tr { display: table-row !important; }
            .report-table th, .report-table td { display: table-cell !important; }
            .report-table thead { display: table-header-group !important; }

            .report-table { width: 100%; border-collapse: collapse; margin-top: 20px; table-layout: fixed; }
            .report-table th { background: transparent !important; color: black !important; border: 1px solid black !important; padding: 10px; text-align: center; white-space: nowrap !important; }
            .report-table td { border: 1px solid black !important; color: black !important; padding: 8px; text-align: center; white-space: nowrap !important; overflow: hidden; text-overflow: ellipsis; }
            .report-table th:first-child, .report-table td:first-child { text-align: left; }
            .report-table tr > *:nth-child(1) { width: 40%; }
            .report-table tr > *:nth-child(2) { width: 30%; }
            .report-table tr > *:nth-child(3) { width: 30%; }
            .report-table tr:nth-child(even) { background-color: transparent !important; }
            .report-summary { margin-top: 20px; border-top: 2px solid black; padding-top: 10px; }

            /* --- TIMETABLE PRINT SPECIFIC --- */
            body.print-mode-timetable #timetable { display: block !important; }
            body.print-mode-timetable .sidebar, 
            body.print-mode-timetable .mobile-header, 
            body.print-mode-timetable .btn, 
            body.print-mode-timetable .action-btn, 
            body.print-mode-timetable .timetable-form { display: none !important; }
            
            body.print-mode-timetable #timetable .split-grid { 
                display: grid !important; 
                grid-template-columns: 1fr 1fr !important; 
                gap: 20px !important; 
            }
            body.print-mode-timetable .schedule-item { border: 1px solid #ccc; box-shadow: none; break-inside: avoid; }
        }
    </style>
</head>
<body>

    <div class="mobile-header">
        <div class="mobile-brand" style="display:flex; align-items:center; gap:10px;">
            <img src="https://edutrackeg.com/_next/image?url=%2Ffavicon.ico&w=1920&q=75" alt="EduTrack Logo" style="height:30px; width:auto;">
        </div>
        <div class="menu-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></div>
    </div>
    <div class="sidebar-backdrop" onclick="toggleSidebar()"></div>

    <nav class="sidebar" id="sidebar">
        <i class="fas fa-times close-btn" onclick="toggleSidebar()"></i>
        <div class="brand">
            <img src="https://edutrackeg.com/_next/image?url=%2Ffavicon.ico&w=1920&q=75" alt="EduTrack Logo" style="height:40px; width:auto;"> <span>EduTrack</span>
        </div>
        <div class="profile-card">
            <div class="avatar"><span id="profileAvatar">S</span><div class="status-dot"></div></div>
            <div class="profile-name" id="profileName">Student</div>
            <div class="profile-role" id="profileOrg">School Name</div>
            <div class="profile-actions">
                <button class="icon-btn" onclick="openProfileModal()" title="Manage Profile"><i class="fas fa-pen"></i></button>
                <button class="icon-btn" onclick="openSwitchModal()" title="Switch User"><i class="fas fa-users"></i></button>
            </div>
        </div>
        <div class="nav-section">
            <button class="nav-btn active" onclick="nav('dashboard')"><i class="fas fa-th-large"></i> Dashboard</button>
            <button class="nav-btn" onclick="nav('timetable')"><i class="fas fa-calendar-alt"></i> Timetable</button>
            <button class="nav-btn" onclick="nav('library')"><i class="fas fa-book"></i> Library</button>
            <button class="nav-btn" onclick="nav('study')"><i class="fas fa-clock"></i> Log Study</button>
            <button class="nav-btn" onclick="nav('exams')"><i class="fas fa-trophy"></i> Exam Marks</button>
        </div>
        <div class="sidebar-footer">
            <button class="nav-btn" onclick="nav('reports')"><i class="fas fa-file-alt"></i> Reports</button>
        </div>
    </nav>

    <div class="main-content">
        <div id="dashboard" class="section-card active">
            <h2 style="margin-bottom:20px;">Overview</h2>
            <div class="stats-row">
                <div class="stat-card card-blue"><h3>Study Today</h3><div class="val" id="todayHours">0h</div><p class="sub">System Date</p><i class="fas fa-clock"></i></div>
                <div class="stat-card card-purple"><h3>Overall Avg</h3><div class="val" id="avgScore">0%</div><p class="sub">All Exams</p><i class="fas fa-chart-pie"></i></div>
                <div class="stat-card card-pink"><h3>Focus Area</h3><div class="val" id="focusArea" style="font-size:1.6rem">None</div><p class="sub">Needs Improvement</p><i class="fas fa-crosshairs"></i></div>
            </div>
            <div class="split-grid">
                <div class="chart-box"><h4 style="margin-bottom:15px; color:#555;">Performance</h4><div style="height:260px"><canvas id="overallChart"></canvas></div></div>
                <div class="chart-box"><h4 style="margin-bottom:15px; color:#555;">Trajectory</h4><div style="height:260px"><canvas id="lineChart"></canvas></div></div>
            </div>
            <h3 style="margin-top:30px; margin-bottom:20px;">Subject Breakdown</h3>
            <div id="miniCharts" class="mini-charts-grid"></div>
        </div>

        <div id="timetable" class="section-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="margin:0;">Weekly Schedule</h2>
                <button class="btn btn-primary" onclick="printTimetable()"><i class="fas fa-print"></i> Print Schedule</button>
            </div>
            
            <div class="split-grid">
                <div>
                    <h3 style="color:var(--primary); margin-bottom:15px;">Weekday (Mon-Fri)</h3>
                    <div class="timetable-form" style="background:white; padding:20px; border-radius:12px; margin-bottom:20px; box-shadow:var(--shadow);">
                        <input type="hidden" id="wdId">
                        <label>Add/Edit Slot</label>
                        <div class="time-inputs">
                            <input type="time" id="wdStart" class="form-control">
                            <input type="time" id="wdEnd" class="form-control">
                        </div>
                        <input type="text" id="wdTitle" class="form-control" placeholder="Activity / Subject Name">
                        <div style="display:flex; gap:10px;">
                            <button id="wdBtn" class="btn btn-primary" style="flex:1" onclick="addSchedule('weekday')">Add</button>
                            <button class="btn" style="background:#dfe6e9; color:#333;" onclick="resetScheduleForm('weekday')">Clear</button>
                        </div>
                    </div>
                    <div id="wdList"></div>
                </div>

                <div>
                    <h3 style="color:var(--accent); margin-bottom:15px;">Weekend (Sat-Sun)</h3>
                    <div class="timetable-form" style="background:white; padding:20px; border-radius:12px; margin-bottom:20px; box-shadow:var(--shadow);">
                        <input type="hidden" id="weId">
                        <label>Add/Edit Slot</label>
                        <div class="time-inputs">
                            <input type="time" id="weStart" class="form-control">
                            <input type="time" id="weEnd" class="form-control">
                        </div>
                        <input type="text" id="weTitle" class="form-control" placeholder="Activity / Subject Name">
                        <div style="display:flex; gap:10px;">
                            <button id="weBtn" class="btn btn-primary" style="flex:1; background:var(--accent)" onclick="addSchedule('weekend')">Add</button>
                            <button class="btn" style="background:#dfe6e9; color:#333;" onclick="resetScheduleForm('weekend')">Clear</button>
                        </div>
                    </div>
                    <div id="weList"></div>
                </div>
            </div>
        </div>

        <div id="library" class="section-card">
            <div class="split-grid">
                <div>
                    <h3 style="color:var(--primary); margin-bottom:15px;">Subjects</h3>
                    <div style="display:flex; gap:10px; margin-bottom:15px;">
                        <input type="text" id="newSubInput" class="form-control" placeholder="Add Subject..." style="margin:0">
                        <button class="btn btn-primary" style="width:auto;" onclick="addItem('subject')"><i class="fas fa-plus"></i></button>
                    </div>
                    <div id="subList" class="tag-container"></div>
                </div>
                <div>
                    <h3 style="color:#e84393; margin-bottom:15px;">Exam Types</h3>
                    <div style="display:flex; gap:10px; margin-bottom:15px;">
                        <input type="text" id="newExamTypeInput" class="form-control" placeholder="Add Exam Type..." style="margin:0">
                        <button class="btn btn-primary" style="width:auto; background:#e84393" onclick="addItem('examType')"><i class="fas fa-plus"></i></button>
                    </div>
                    <div id="examTypeList" class="tag-container"></div>
                </div>
            </div>
        </div>

        <div id="study" class="section-card">
            <div class="page-grid">
                <div>
                    <h2 style="color:var(--accent); margin-bottom:20px;">Log Session</h2>
                    <form onsubmit="saveStudy(event)">
                        <input type="hidden" id="studyId">
                        <label>Subject</label><select id="studySub" class="form-control" required></select>
                        <label>Duration (Mins)</label><input type="number" id="studyTime" class="form-control" required>
                        <label>Date</label><input type="date" id="studyDate" class="form-control" required>
                        <button type="submit" id="studyBtn" class="btn btn-primary" style="width:100%">Save Log</button>
                        <button type="button" onclick="resetForm('study')" class="btn" style="width:100%; margin-top:10px; background:#dfe6e9; color:#333;">Cancel</button>
                    </form>
                </div>
                <div>
                    <h3 style="margin-bottom:20px;">Recent Logs</h3>
                    <table id="studyTable"><thead><tr><th>Date</th><th>Subject</th><th>Duration</th><th>Actions</th></tr></thead><tbody></tbody></table>
                </div>
            </div>
        </div>

        <div id="exams" class="section-card">
            <div class="page-grid">
                <div>
                    <h2 style="color:var(--primary); margin-bottom:20px;">Enter Marks</h2>
                    <form onsubmit="saveExam(event)">
                        <input type="hidden" id="examId">
                        <label>Exam Type</label><select id="examName" class="form-control" required></select>
                        <label>Subject</label><select id="examSub" class="form-control" required></select>
                        <label>Score (%)</label><input type="number" id="examScore" class="form-control" max="100" required>
                        <button type="submit" id="examBtn" class="btn btn-primary" style="width:100%">Save Result</button>
                        <button type="button" onclick="resetForm('exam')" class="btn" style="width:100%; margin-top:10px; background:#dfe6e9; color:#333;">Cancel</button>
                    </form>
                </div>
                <div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
                        <h3>History</h3>
                        <select id="examFilter" class="form-control" style="width:auto; margin:0;" onchange="renderTables()">
                            <option value="All">All Exams</option>
                        </select>
                    </div>
                    <table id="examTable"><thead><tr><th>Exam</th><th>Subject</th><th>Score</th><th>Actions</th></tr></thead><tbody></tbody></table>
                </div>
            </div>
        </div>

        <div id="reports" class="section-card">
            <div class="report-toolbar no-print">
                <div class="filter-group">
                    <label>Report Period</label>
                    <select id="repFilter" class="form-control" onchange="updateReportDates()">
                        <option value="date">Specific Date</option>
                        <option value="custom">Custom Range</option>
                        <option value="7days">Last 7 Days</option>
                        <option value="month">Monthly (Last 6)</option>
                        <option value="year">Yearly (Last 6)</option>
                    </select>
                </div>
                
                <div id="dynamicFilterContainer"></div>
                
                <div id="singleDateInput" class="date-group" style="display:none;">
                    <div><label>Select Date</label><input type="date" id="repSingleDate" class="form-control"></div>
                </div>

                <div id="dateInputs" class="date-group" style="display:none;">
                    <div><label>From</label><input type="date" id="repStart" class="form-control"></div>
                    <div><label>To</label><input type="date" id="repEnd" class="form-control"></div>
                </div>
                
                <div class="btn-group-responsive">
                    <button class="btn btn-primary" style="flex:2" onclick="genReport()">Generate</button>
                    <button class="btn" style="background:#2d3436; color:white; flex:1;" onclick="window.print()"><i class="fas fa-print"></i></button>
                </div>
            </div>
            
            <div id="reportContent" class="report-paper">
                <div class="report-header">
                    <h1 class="report-brand" id="repSchoolName">SCHOOL NAME</h1>
                    <p class="report-sub">Student Academic & Study Report</p>
                </div>
                <div class="student-details-grid">
                    <div class="detail-item"><strong>Name</strong><span id="repStudentName">Name</span></div>
                    <div class="detail-item"><strong>Roll Number</strong><span id="repRoll">--</span></div>
                    <div class="detail-item"><strong>Class/Grade</strong><span id="repClass">--</span></div>
                    <div class="detail-item"><strong>Period</strong><span id="repPeriod">--</span></div>
                </div>
                <h3 style="border-bottom: 2px solid #eee; padding-bottom:10px; margin-bottom:10px;">Study Log Summary</h3>
                <table class="report-table">
                    <thead><tr><th>Subject</th><th>Activity Date</th><th>Duration</th></tr></thead>
                    <tbody id="repTableBody"></tbody>
                </table>
                <div class="report-summary" id="repTotal"></div>
                <div class="signature-section" style="display:none; margin-top:100px; justify-content:space-between;">
                    <div style="text-align:center; border-top:1px solid #000; padding-top:10px; width:200px;">Student Signature</div>
                    <div style="text-align:center; border-top:1px solid #000; padding-top:10px; width:200px;">Parent/Teacher Signature</div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="genericModal">
        <div class="modal-box"><div class="modal-icon icon-info" id="modalIcon"><i class="fas fa-info"></i></div><h3 id="modalTitle">Title</h3><p id="modalMsg" style="color:#636e72; margin-bottom:25px;">Message</p><button class="btn btn-primary" style="width:100%" onclick="closeModals()">OK</button></div>
    </div>
    <div class="modal-overlay" id="confirmModal">
        <div class="modal-box"><div class="modal-icon icon-warn"><i class="fas fa-exclamation"></i></div><h3>Are you sure?</h3><p id="confirmMsg" style="color:#636e72; margin-bottom:25px;">Action cannot be undone.</p><div style="display:flex; gap:10px;"><button class="btn btn-danger" style="flex:1" onclick="executeConfirm()">Yes, Delete</button><button class="btn" style="background:#dfe6e9; color:#333; flex:1" onclick="closeModals()">Cancel</button></div></div>
    </div>
    <div class="modal-overlay" id="profileModal">
        <div class="modal-box"><h3 style="margin-bottom:20px; color:var(--primary);">Manage Profile</h3><div class="profile-form-grid"><div class="full-width"><label>Full Name</label><input type="text" id="profName" class="form-control" placeholder="Student Name"></div><div class="full-width"><label>School / Organization</label><input type="text" id="profOrg" class="form-control" placeholder="School Name"></div><div><label>Class/Grade</label><input type="text" id="profClass" class="form-control" placeholder="e.g. 10th"></div><div><label>Section</label><input type="text" id="profSec" class="form-control" placeholder="e.g. A"></div><div class="full-width"><label>Roll Number</label><input type="text" id="profRoll" class="form-control" placeholder="e.g. 10245"></div></div><button class="btn btn-primary" style="width:100%; margin-top:20px;" onclick="saveProfile()">Save Details</button><button class="btn" style="width:100%; margin-top:10px; background:#dfe6e9; color:#333;" onclick="closeModals()">Cancel</button></div>
    </div>
    <div class="modal-overlay" id="switchModal">
        <div class="modal-box"><div class="modal-icon icon-info"><i class="fas fa-users"></i></div><h3>Switch Profile</h3><div id="userList" style="text-align:left; margin:20px 0; max-height:150px; overflow-y:auto; border:1px solid #eee; border-radius:8px;"></div><button class="btn btn-primary" style="width:100%" onclick="createUserPrompt()">Create New Profile</button><button class="btn" style="width:100%; margin-top:10px; background:#dfe6e9; color:#333;" onclick="closeModals()">Cancel</button></div>
    </div>

    <script>
        const DEF_SUBS = ['Maths', 'Physics', 'Chemistry', 'Biology', 'English'];
        const DEF_EXAMS = ['Unit Test 1', 'Mid-Term', 'Final Exam'];
        let db = JSON.parse(localStorage.getItem('eduPremium_v2')) || { users: ['Student 1'], current: 'Student 1', data: { 'Student 1': { info: { name: 'Student 1', school: 'My School', grade: '', section: '', roll: '' }, study:[], exams:[], subjects:[...DEF_SUBS], examTypes:[...DEF_EXAMS], timetable: { weekday: [], weekend: [] } } } };
        
        // MIGRATION CHECK FOR OLD DATA WITHOUT TIMETABLE
        if (!db.data[db.current].timetable) {
            db.data[db.current].timetable = { weekday: [], weekend: [] };
        }

        let charts = { over:null, line:null, mini:[] }, pendingCallback = null;

        function getTodayDate() { const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
        function getMonthName(idx) { return ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"][idx]; }

        window.onload = () => {
            const d = db.data[db.current];
            if(!d.info) { d.info = { name: db.current, school: 'EduTrack High', grade: '', section: '', roll: '' }; saveDB(); }
            if(!d.timetable) { d.timetable = { weekday: [], weekend: [] }; saveDB(); }
            
            document.getElementById('studyDate').value = getTodayDate();
            document.getElementById('repSingleDate').value = getTodayDate(); 
            document.getElementById('repEnd').value = getTodayDate();
            updateReportDates(); renderUI();
        };

        function saveDB() { localStorage.setItem('eduPremium_v2', JSON.stringify(db)); renderUI(); }
        function getUUID() { return Math.random().toString(36).substr(2, 9); }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); document.querySelector('.sidebar-backdrop').classList.toggle('active'); }
        function nav(id) {
            document.querySelectorAll('.section-card').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => { b.classList.remove('active'); if(b.getAttribute('onclick').includes(id)) b.classList.add('active'); });
            if(window.innerWidth <= 768 && document.getElementById('sidebar').classList.contains('active')) toggleSidebar();
        }
        function closeModals() { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('open')); }
        function showModal(title, msg, type='info') { document.getElementById('modalTitle').innerText = title; document.getElementById('modalMsg').innerText = msg; document.getElementById('modalIcon').className = `modal-icon ${type==='success'?'icon-success':type==='warn'?'icon-warn':'icon-info'}`; document.getElementById('genericModal').classList.add('open'); }
        function showConfirm(msg, callback) { document.getElementById('confirmMsg').innerText = msg; pendingCallback = callback; document.getElementById('confirmModal').classList.add('open'); }
        function executeConfirm() { if(pendingCallback) pendingCallback(); closeModals(); }
        function openProfileModal() { const info = db.data[db.current].info; document.getElementById('profName').value = info.name; document.getElementById('profOrg').value = info.school; document.getElementById('profClass').value = info.grade; document.getElementById('profSec').value = info.section; document.getElementById('profRoll').value = info.roll; document.getElementById('profileModal').classList.add('open'); }
        function saveProfile() { const info = db.data[db.current].info; info.name = document.getElementById('profName').value.trim() || db.current; info.school = document.getElementById('profOrg').value.trim(); info.grade = document.getElementById('profClass').value.trim(); info.section = document.getElementById('profSec').value.trim(); info.roll = document.getElementById('profRoll').value.trim(); saveDB(); closeModals(); showModal('Success', 'Profile Updated!', 'success'); }

        function updateReportDates() {
            const type = document.getElementById('repFilter').value;
            const dContainer = document.getElementById('dynamicFilterContainer');
            const rangeInputs = document.getElementById('dateInputs');
            const singleInput = document.getElementById('singleDateInput');
            
            dContainer.innerHTML = ''; 
            rangeInputs.style.display = 'none';
            singleInput.style.display = 'none';

            const today = new Date();
            
            if (type === 'custom') {
                rangeInputs.style.display = 'flex';
            } else if (type === 'date') {
                singleInput.style.display = 'flex';
            } else if (type === '7days') {
                let start = new Date(); start.setDate(today.getDate() - 7);
                document.getElementById('repStart').value = start.toISOString().split('T')[0];
                document.getElementById('repEnd').value = getTodayDate();
            } else if (type === 'month') {
                let opts = ''; for(let i=0; i<6; i++) { let d = new Date(today.getFullYear(), today.getMonth()-i, 1); opts += `<option value="${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}">${getMonthName(d.getMonth())} ${d.getFullYear()}</option>`; }
                dContainer.innerHTML = `<label>Select Month</label><select id="monthPick" class="form-control" style="margin-bottom:0" onchange="autoSetMonth()">${opts}</select>`;
                autoSetMonth();
            } else if (type === 'year') {
                let opts = ''; for(let i=0; i<6; i++) { let yr = today.getFullYear()-i; opts += `<option value="${yr}">${yr}</option>`; }
                dContainer.innerHTML = `<label>Select Year</label><select id="yearPick" class="form-control" style="margin-bottom:0" onchange="autoSetYear()">${opts}</select>`;
                autoSetYear();
            }
        }
        function autoSetMonth() { const val = document.getElementById('monthPick').value; const [y, m] = val.split('-'); const lastDay = new Date(y, m, 0).getDate(); document.getElementById('repStart').value = `${val}-01`; document.getElementById('repEnd').value = `${val}-${lastDay}`; }
        function autoSetYear() { const yr = document.getElementById('yearPick').value; document.getElementById('repStart').value = `${yr}-01-01`; document.getElementById('repEnd').value = `${yr}-12-31`; }

        function genReport() {
            const type = document.getElementById('repFilter').value;
            let start, end;
            if(type === 'date') {
                const single = document.getElementById('repSingleDate').value;
                if(!single) return showModal('Error', 'Please select a date', 'warn');
                start = single; end = single;
            } else {
                start = document.getElementById('repStart').value;
                end = document.getElementById('repEnd').value;
            }
            if(!start || !end) return showModal('Error', 'Invalid Dates', 'warn');
            const d = db.data[db.current]; const logs = d.study.filter(l => l.date >= start && l.date <= end);
            if(!logs.length) { document.getElementById('reportContent').style.display = 'none'; return showModal('No Data', 'No logs found for this period.', 'info'); }
            document.getElementById('repSchoolName').innerText = d.info.school || "EduTrack Academy"; document.getElementById('repStudentName').innerText = d.info.name; document.getElementById('repRoll').innerText = d.info.roll || "--"; document.getElementById('repClass').innerText = (d.info.grade ? d.info.grade : "") + (d.info.section ? " '"+d.info.section+"'" : ""); document.getElementById('repPeriod').innerText = (start === end) ? start : `${start} to ${end}`;
            logs.sort((a,b) => b.date.localeCompare(a.date)); let total = 0;
            document.getElementById('repTableBody').innerHTML = logs.map(l => { total += l.mins; return `<tr><td>${l.sub}</td><td>${l.date}</td><td>${l.mins}m</td></tr>`; }).join('');
            document.getElementById('repTotal').innerText = `Total Study Time: ${Math.floor(total/60)}h ${total%60}m`; document.getElementById('reportContent').style.display = 'block';
        }

        // --- TIMETABLE LOGIC ---

        function addSchedule(type) {
            const startId = type === 'weekday' ? 'wdStart' : 'weStart';
            const endId = type === 'weekday' ? 'wdEnd' : 'weEnd';
            const titleId = type === 'weekday' ? 'wdTitle' : 'weTitle';
            const hiddenId = type === 'weekday' ? 'wdId' : 'weId';
            
            const start = document.getElementById(startId).value;
            const end = document.getElementById(endId).value;
            const title = document.getElementById(titleId).value.trim();
            const id = document.getElementById(hiddenId).value; // Check if editing
            
            if (!start || !end || !title) return showModal('Error', 'Please fill all fields', 'warn');
            
            const d = db.data[db.current];

            if (id) {
                // EDIT MODE
                const idx = d.timetable[type].findIndex(x => x.id === id);
                if (idx !== -1) {
                    d.timetable[type][idx] = { id, start, end, title };
                    showModal('Success', 'Schedule Updated', 'success');
                }
            } else {
                // ADD MODE
                d.timetable[type].push({ id: getUUID(), start, end, title });
                showModal('Success', 'Added to Schedule', 'success');
            }
            
            // Sort by start time
            d.timetable[type].sort((a,b) => a.start.localeCompare(b.start));
            
            resetScheduleForm(type);
            saveDB();
        }
        
        function editSchedule(type, id) {
            const d = db.data[db.current];
            const item = d.timetable[type].find(x => x.id === id);
            if (!item) return;

            // Populate form
            document.getElementById(type === 'weekday' ? 'wdStart' : 'weStart').value = item.start;
            document.getElementById(type === 'weekday' ? 'wdEnd' : 'weEnd').value = item.end;
            document.getElementById(type === 'weekday' ? 'wdTitle' : 'weTitle').value = item.title;
            document.getElementById(type === 'weekday' ? 'wdId' : 'weId').value = item.id;

            // Change Button Text
            const btn = document.getElementById(type === 'weekday' ? 'wdBtn' : 'weBtn');
            btn.innerText = 'Update';
            
            // Scroll to form (optional UX improvement)
            btn.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function resetScheduleForm(type) {
            document.getElementById(type === 'weekday' ? 'wdStart' : 'weStart').value = '';
            document.getElementById(type === 'weekday' ? 'wdEnd' : 'weEnd').value = '';
            document.getElementById(type === 'weekday' ? 'wdTitle' : 'weTitle').value = '';
            document.getElementById(type === 'weekday' ? 'wdId' : 'weId').value = '';
            document.getElementById(type === 'weekday' ? 'wdBtn' : 'weBtn').innerText = 'Add';
        }

        function deleteSchedule(type, id) {
            showConfirm('Remove this slot?', () => {
                const d = db.data[db.current];
                d.timetable[type] = d.timetable[type].filter(x => x.id !== id);
                saveDB();
            });
        }

        function printTimetable() {
            document.body.classList.add('print-mode-timetable');
            window.print();
            document.body.classList.remove('print-mode-timetable');
        }
        
        function renderTimetable() {
            const d = db.data[db.current];
            if(!d.timetable) return;

            const renderItem = (i, type) => `
                <div class="schedule-item ${type === 'weekend' ? 'weekend-item' : ''}">
                    <div>
                        <span class="schedule-time">${i.start} - ${i.end}</span>
                        <span class="schedule-title">${i.title}</span>
                    </div>
                    <div>
                        <button class="action-btn btn-edit" onclick="editSchedule('${type}', '${i.id}')"><i class="fas fa-pen"></i></button>
                        <button class="action-btn btn-del" onclick="deleteSchedule('${type}', '${i.id}')"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `;

            document.getElementById('wdList').innerHTML = d.timetable.weekday.length 
                ? d.timetable.weekday.map(i => renderItem(i, 'weekday')).join('') 
                : '<p style="color:#aaa; text-align:center;">No schedule added.</p>';
            
            document.getElementById('weList').innerHTML = d.timetable.weekend.length 
                ? d.timetable.weekend.map(i => renderItem(i, 'weekend')).join('') 
                : '<p style="color:#aaa; text-align:center;">No schedule added.</p>';
        }

        function renderUI() {
            const d = db.data[db.current]; if(!d) return;
            document.getElementById('profileName').innerText = d.info.name; document.getElementById('profileOrg').innerText = d.info.school || "No School Added"; document.getElementById('profileAvatar').innerText = d.info.name[0].toUpperCase();
            const today = getTodayDate(); const tMins = d.study.filter(s => s.date === today).reduce((a,b)=>a+b.mins,0); document.getElementById('todayHours').innerText = `${Math.floor(tMins/60)}h ${tMins%60}m`;
            const avg = d.exams.length ? (d.exams.reduce((a,b)=>a+b.score,0)/d.exams.length).toFixed(1) : 0; document.getElementById('avgScore').innerText = avg+'%';
            let sSum={}, sCnt={}; d.subjects.forEach(s => { sSum[s]=0; sCnt[s]=0; }); d.exams.forEach(e => { if(d.subjects.includes(e.sub)){ sSum[e.sub]+=e.score; sCnt[e.sub]++; }});
            let min=101, focus='None'; for(let s in sSum) if(sCnt[s]>0 && (sSum[s]/sCnt[s])<min) { min=sSum[s]/sCnt[s]; focus=s; } document.getElementById('focusArea').innerText = focus;
            const subHtml = d.subjects.map(s => `<option>${s}</option>`).join(''); document.getElementById('studySub').innerHTML = subHtml; document.getElementById('examSub').innerHTML = subHtml;
            document.getElementById('subList').innerHTML = d.subjects.map(s => `<span class="item-tag tag-sub" onclick="confirmDel('Subject', '${s}')">${s} </span>`).join('');
            const examHtml = d.examTypes.map(e => `<option>${e}</option>`).join(''); document.getElementById('examName').innerHTML = examHtml;
            document.getElementById('examTypeList').innerHTML = d.examTypes.map(e => `<span class="item-tag tag-exam" onclick="confirmDel('Exam Type', '${e}')">${e} </span>`).join('');
            document.getElementById('examFilter').innerHTML = `<option value="All">All Exams</option>` + examHtml; document.getElementById('examFilter').value = document.getElementById('examFilter').value;
            renderTables(); renderCharts(); renderTimetable();
        }

        function renderTables() {
            const d = db.data[db.current];
            document.querySelector('#studyTable tbody').innerHTML = [...d.study].reverse().slice(0,10).map(s => `<tr><td data-label="Date">${s.date}</td><td data-label="Subject"><span class="item-tag tag-sub" style="width:fit-content; cursor:default">${s.sub}</span></td><td data-label="Time">${s.mins}m</td><td data-label="Actions"><button class="action-btn btn-edit" onclick="editItem('study', '${s.id}')"><i class="fas fa-pen"></i></button><button class="action-btn btn-del" onclick="confirmDel('Study Log', '${s.id}')"><i class="fas fa-trash"></i></button></td></tr>`).join('');
            let list = [...d.exams]; const filter = document.getElementById('examFilter').value; if(filter !== 'All') list = list.filter(e => e.name === filter); list.sort((a,b) => a.sub.localeCompare(b.sub));
            document.querySelector('#examTable tbody').innerHTML = list.map(e => `<tr><td data-label="Exam">${e.name}</td><td data-label="Subject"><span style="font-weight:600; color:var(--primary)">${e.sub}</span></td><td data-label="Score" style="font-weight:bold; color:${e.score>=80?'#00b894':e.score>=50?'#e17055':'#d63031'}">${e.score}%</td><td data-label="Actions"><button class="action-btn btn-edit" onclick="editItem('exam', '${e.id}')"><i class="fas fa-pen"></i></button><button class="action-btn btn-del" onclick="confirmDel('Exam Result', '${e.id}')"><i class="fas fa-trash"></i></button></td></tr>`).join('');
        }

        function renderCharts() {
            const d = db.data[db.current]; const t = d.examTypes; const avgs = t.map(name => { const f = d.exams.filter(e => e.name === name); return f.length ? (f.reduce((a,b)=>a+b.score,0)/f.length).toFixed(1) : 0; });
            // UPDATED CHART COLOR TO BLUE
            if(charts.over) charts.over.destroy(); charts.over = new Chart(document.getElementById('overallChart'), { type: 'bar', data: { labels: t, datasets: [{ label: 'Avg %', data: avgs, backgroundColor: '#3d5afe', borderRadius: 6 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { max: 100 } } } });
            if(charts.line) charts.line.destroy(); const chronologicalExams = [...d.exams]; charts.line = new Chart(document.getElementById('lineChart'), { type: 'line', data: { labels: chronologicalExams.map(e => e.sub.substring(0,3)), datasets: [{ label: 'Score', data: chronologicalExams.map(e => e.score), borderColor: '#00cec9', tension: 0.3, fill: true, backgroundColor: 'rgba(0, 206, 201, 0.1)' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { max: 100 } }, plugins:{legend:{display:false}} } });
            const miniCon = document.getElementById('miniCharts'); miniCon.innerHTML = ''; charts.mini.forEach(c => c.destroy()); charts.mini = [];
            
            // COLOR PALETTE FOR BARS
            const colors = ['#ff7675', '#6c5ce7', '#00b894', '#0984e3', '#fdcb6e', '#e17055', '#00cec9', '#636e72'];

            d.subjects.forEach((sub, i) => { 
                const f = d.exams.filter(e => e.sub === sub); 
                const div = document.createElement('div'); 
                div.className = 'mini-chart-card'; 
                // Increased height to 220px to fit axes labels comfortably
                div.innerHTML = `<h5 style="margin-bottom:10px">${sub}</h5><div style="height:220px"><canvas id="m-${i}"></canvas></div>`; 
                miniCon.appendChild(div); 
                
                charts.mini.push(new Chart(document.getElementById(`m-${i}`), { 
                    type: 'bar', // Changed to Bar Chart
                    data: { 
                        labels: f.map(e=>e.name), 
                        datasets: [{ 
                            data: f.map(e=>e.score), 
                            backgroundColor: colors, // Colorful Palette applied here (cycles through array)
                            borderRadius: 4,
                            borderWidth: 0
                        }] 
                    }, 
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins:{legend:{display:false}}, 
                        scales:{
                            x: {
                                display: true,
                                title: { display: true, text: 'Exam Name', color: '#636e72', font: {size:11, weight:'bold'} }
                            }, 
                            y: {
                                display: true, 
                                min: 0, 
                                max: 100,
                                title: { display: true, text: 'Score %', color: '#636e72', font: {size:11, weight:'bold'} }
                            }
                        } 
                    } 
                })); 
            });
        }

        function addItem(type) { const inp = document.getElementById(type === 'subject' ? 'newSubInput' : 'newExamTypeInput'); const val = inp.value.trim(); const list = type === 'subject' ? db.data[db.current].subjects : db.data[db.current].examTypes; if(val && !list.includes(val)) { list.push(val); saveDB(); showModal('Success', 'Item Added!', 'success'); inp.value=''; } }
        function confirmDel(type, id) { showConfirm(`Delete ${type}: ${id}?`, () => { const d = db.data[db.current]; if(type === 'Study Log') d.study = d.study.filter(x => x.id !== id); else if(type === 'Exam Result') d.exams = d.exams.filter(x => x.id !== id); else if(type === 'Subject') d.subjects = d.subjects.filter(x => x !== id); else if(type === 'Exam Type') d.examTypes = d.examTypes.filter(x => x !== id); saveDB(); }); }
        function saveStudy(e) { e.preventDefault(); const id = document.getElementById('studyId').value; const obj = { id: id || getUUID(), sub: document.getElementById('studySub').value, mins: parseInt(document.getElementById('studyTime').value), date: document.getElementById('studyDate').value }; const d = db.data[db.current]; if(id) { const i = d.study.findIndex(x=>x.id===id); if(i!==-1) d.study[i]=obj; } else d.study.push(obj); saveDB(); resetForm('study'); showModal('Success', 'Log Saved', 'success'); }
        function saveExam(e) { e.preventDefault(); const id = document.getElementById('examId').value; const obj = { id: id || getUUID(), name: document.getElementById('examName').value, sub: document.getElementById('examSub').value, score: parseInt(document.getElementById('examScore').value) }; const d = db.data[db.current]; if(id) { const i = d.exams.findIndex(x=>x.id===id); if(i!==-1) d.exams[i]=obj; } else d.exams.push(obj); saveDB(); resetForm('exam'); showModal('Success', 'Score Saved', 'success'); }
        function editItem(type, id) { const d = db.data[db.current]; if(type === 'study') { const item = d.study.find(x => x.id === id); document.getElementById('studyId').value = item.id; document.getElementById('studySub').value = item.sub; document.getElementById('studyTime').value = item.mins; document.getElementById('studyDate').value = item.date; document.getElementById('studyBtn').innerText = 'Update'; nav('study'); } else { const item = d.exams.find(x => x.id === id); document.getElementById('examId').value = item.id; document.getElementById('examName').value = item.name; document.getElementById('examSub').value = item.sub; document.getElementById('examScore').value = item.score; document.getElementById('examBtn').innerText = 'Update'; nav('exams'); } }
        function resetForm(type) { const formId = type==='study' ? 'study' : 'exams'; document.querySelector(`#${formId} form`).reset(); document.getElementById(`${type}Id`).value = ''; document.getElementById(`${type}Btn`).innerText = 'Save'; if(type==='study') document.getElementById('studyDate').value = getTodayDate(); }
        function createUserPrompt() { const name = prompt("Enter new Profile Identifier (e.g. Student 2):"); if(name && !db.users.includes(name)) { db.users.push(name); db.data[name] = { info: { name: name, school: '', grade: '', section: '', roll: '' }, study:[], exams:[], subjects:[...DEF_SUBS], examTypes:[...DEF_EXAMS], timetable: { weekday: [], weekend: [] } }; db.current = name; saveDB(); closeModals(); location.reload(); } else if (name) alert("User already exists!"); }
        function openSwitchModal() { document.getElementById('userList').innerHTML = db.users.map(u => `<div onclick="switchUser('${u}')" style="padding:12px; border-bottom:1px solid #eee; cursor:pointer; display:flex; justify-content:space-between; align-items:center;"><span style="font-weight:500">${db.data[u]?.info?.name || u}</span> ${u===db.current?'<i class="fas fa-check" style="color:#00b894"></i>':''}</div>`).join(''); document.getElementById('switchModal').classList.add('open'); }
        function switchUser(u) { db.current = u; saveDB(); location.reload(); }
    </script>
</body>
</html>
